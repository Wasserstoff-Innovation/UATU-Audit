<!doctype html>
<html><head><meta charset="utf-8"><title>Uatu Audit Report</title>
<style>
:root{
  --ink:#2c3e50; --slate:#34495e; --edge:#7f8c8d; --glow:#f7d046;
  --paper:#ffffff; --panel:#f8f9fa; --muted:#6c757d;
  --ok:#28a745; --warn:#ffc107; --accent:#007bff; --danger:#dc3545;
}
*{box-sizing:border-box} html,body{height:100%;margin:0;padding:0}
body{background:var(--paper);color:var(--ink);font:14px/1.4 Inter,system-ui,-apple-system,sans-serif}
.hero{background:linear-gradient(135deg,var(--slate),var(--edge));padding:40px 20px;text-align:center;border-bottom:1px solid var(--edge)}
.hero h1{font-size:36px;margin:0 0 8px 0;color:var(--glow);text-shadow:0 0 20px rgba(247,208,70,.3)}
.hero .subtitle{color:#d7e6f7;font-size:16px;margin:0 0 20px 0}
.hero .stats{display:flex;justify-content:center;gap:30px;margin:20px 0}
.stat{text-align:center}
.stat .value{font-size:24px;font-weight:700;color:var(--glow)}
.stat .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
.container{max-width:1000px;margin:0 auto;padding:20px}
.section{margin:30px 0}
.section h2{color:var(--glow);border-bottom:2px solid var(--edge);padding-bottom:8px;margin-bottom:16px}
table{border-collapse:collapse;width:100%;background:var(--panel);border:1px solid var(--edge)}
th,td{border:1px solid var(--edge);padding:8px;text-align:left}
th{background:var(--slate);color:var(--glow);font-weight:600}
tr:nth-child(even){background:rgba(31,59,87,0.2)}
.badge{display:inline-block;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-right:4px}
.grade-critical{background:#ffcccc;color:#8b0000}
.grade-high{background:#ffd6cc;color:#cc4400}
.grade-medium{background:#fff0cc;color:#cc8800}
.grade-low{background:#f2ffcc;color:#448800}
.grade-info{background:#e6ffe6;color:#006600}
.delta-up{color:var(--danger)}
.delta-down{color:var(--ok)}
.compact{font-size:12px}
.compact th, .compact td{padding:4px 6px}
@media print{
  .hero{background:#f8f9fa;color:#333}
  .hero h1{color:#2c3e50}
  body{background:white;color:#333}
  .section h2{color:#2c3e50;border-color:#ddd}
  table{background:white;border-color:#ddd}
  th{background:#f5f5f5;color:#2c3e50}
}
</style>
</head>
<body>
  <div class="hero">
    <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:20px;">
              <img src="{{ outdir }}/uatu-logo.svg" alt="Uatu Logo" style="width:120px;height:auto;">
      <h1>Uatu Audit Report</h1>
    </div>
    <p class="subtitle">Smart Contract Security Analysis</p>
    <div style="margin:20px 0;">
      <img src="{{ outdir }}/uatu-mascot.png" alt="Uatu Mascot" style="width:120px;height:auto;opacity:0.8;" onerror="this.style.display='none'">
    </div>
    <div class="stats">
      <div class="stat">
        <div class="value">{{ risk_summary.overall|default(0)|round(1) }}</div>
        <div class="label">Risk Score</div>
      </div>
      <div class="stat">
        <div class="value">{{ risk_summary.grade|default('N/A') }}</div>
        <div class="label">Grade</div>
      </div>
      <div class="stat">
        <div class="value">{{ flows.contracts|length }}</div>
        <div class="label">Contracts</div>
      </div>
      <div class="stat">
        <div class="value">{{ test_runs|length }}</div>
        <div class="label">Test Journeys</div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="section">
      <h2>Executive Summary</h2>
      <p><strong>Analysis Mode:</strong> {{ static_meta.mode or 'unknown' }}{% if static_meta.ok is defined %} ({{ 'success' if static_meta.ok else 'failed' }}){% endif %}</p>
      {% if risk_summary and risk_summary.delta_overall %}
        <p><strong>Risk Trend:</strong> 
          {% set d = risk_summary.delta_overall %}
          {% if d > 0 %}
            <span class="delta-up">+{{ "%.1f"|format(d) }} ↑ (worse)</span>
          {% elif d < 0 %}
            <span class="delta-down">{{ "%.1f"|format(d) }} ↓ (better)</span>
          {% else %}
            <span>0.0 (stable)</span>
          {% endif %}
        </p>
      {% endif %}
    </div>

    <div class="section">
      <h2>Contract Inventory</h2>
      <table class="compact">
        <tr><th>Contract</th><th>Functions</th><th>Events</th><th>Standards</th></tr>
        {% for c in flows.contracts %}
        <tr>
          <td><strong>{{ c.name }}</strong></td>
          <td>{{ c.functions|length }}</td>
          <td>{{ c.events|length }}</td>
          <td>
            {% for std in flows.standards %}
              {% if std in c.name or std in (c.inherits or []) %}
                <span class="badge grade-info">{{ std }}</span>
              {% endif %}
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>

    {% set slither_norm = outdir + '/runs/static/slither.normalized.json' %}
    {% set findings = [] %}
    {% if slither_norm %}
      {% set _ignore = findings.extend(load_json(slither_norm)) %}
    {% endif %}
    
    <div class="section">
      <h2>Security Findings</h2>
      {% if findings|length == 0 %}
        <p>✅ No security findings detected by Slither.</p>
      {% else %}
        <table class="compact">
          <tr><th>Severity</th><th>Issue</th><th>Location</th></tr>
          {% for f in findings[:10] %}
            <tr>
              <td><span class="badge grade-{{ f.severity|lower }}">{{ f.severity }}</span></td>
              <td>{{ f.title }}</td>
              <td>{{ (f.contract or '-') ~ '.' ~ (f.function or '-') }}</td>
            </tr>
          {% endfor %}
        </table>
        {% if findings|length > 10 %}
          <p><em>... and {{ findings|length - 10 }} more findings. See full report for details.</em></p>
        {% endif %}
      {% endif %}
    </div>

    {% set threats_json = outdir + '/threats.json' %}
    {% set threats = {} %}
    {% if threats_json %}
      {% set threats = load_json(threats_json) %}
    {% endif %}
    
    <div class="section">
      <h2>Test Results</h2>
      {% if test_runs|length == 0 %}
        <p>No test journeys executed.</p>
      {% else %}
        <table class="compact">
          <tr><th>Journey</th><th>Status</th><th>Tests</th><th>Gas (avg)</th></tr>
          {% for r in test_runs %}
            {% set total_tests = r.passed + r.failed %}
            {% set avg_gas = (r.gas.values()|list|sum / r.gas|length)|round if r.gas else 0 %}
            <tr>
              <td>{{ r.project }}</td>
              <td>
                {% if r.failed == 0 %}
                  <span class="badge grade-info">✅ PASS</span>
                {% elif r.passed == 0 %}
                  <span class="badge grade-critical">❌ FAIL</span>
                {% else %}
                  <span class="badge grade-warn">⚠️ PARTIAL</span>
                {% endif %}
              </td>
              <td>{{ r.passed }}/{{ total_tests }}</td>
              <td>{{ avg_gas if avg_gas > 0 else '-' }}</td>
            </tr>
          {% endfor %}
        </table>
      {% endif %}
    </div>

    <div class="section">
      <h2>Risk Analysis</h2>
      {% if risk_summary and risk_summary.buckets %}
        <p><strong>Risk Distribution:</strong>
          {% for grade, count in risk_summary.buckets.items() %}
            {% if count > 0 %}
              <span class="badge grade-{{ grade|lower }}">{{ grade }}: {{ count }}</span>
            {% endif %}
          {% endfor %}
        </p>
      {% endif %}
      
      {% if risk_heatmap and risk_heatmap|length > 0 %}
        <h3>Top Risk Functions</h3>
        <table class="compact">
          <tr><th>Function</th><th>Score</th><th>Δ</th><th>Grade</th><th>STRIDE</th></tr>
          {% for row in risk_heatmap[:10] %}
            <tr>
              <td>{{ row.contract }}.{{ row.function }}</td>
              <td>{{ "%.1f"|format(row.score) }}</td>
              <td>
                {% set delta = row.delta if row and 'delta' in row else 0 %}
                {% if delta>0 %}<span class="delta-up">+{{"%.1f"|format(delta)}} ↑</span>
                {% elif delta<0 %}<span class="delta-down">{{"%.1f"|format(delta)}} ↓</span>
                {% else %}<span>0.0</span>{% endif %}
              </td>
              <td><span class="badge grade-{{ row.grade|lower }}">{{ row.grade }}</span></td>
              <td>
                {% for c in row.cats[:2] %}
                  <span class="badge" style="background:{{ stride_badges.get(c, '#eee') }};">{{ c[:3] }}</span>
                {% endfor %}
              </td>
            </tr>
          {% endfor %}
        </table>
      {% endif %}
    </div>

    {% if risk_trend and risk_trend.svg_data_uri %}
    <div class="section">
      <h2>Risk Trend</h2>
      <p><strong>Last {{ risk_trend.meta.count }} runs:</strong>
        <img src="{{ risk_trend.svg_data_uri }}" alt="risk trend" style="vertical-align: middle; margin-left: 8px;" />
        <br/>
        <small style="color: var(--muted);">
          Latest: <b>{{ "%.1f"|format(risk_trend.meta.latest) }}</b> • 
          Min: <b>{{ "%.1f"|format(risk_trend.meta.min) }}</b> • 
          Max: <b>{{ "%.1f"|format(risk_trend.meta.max) }}</b>
        </small>
      </p>
    </div>
    {% endif %}

    <div class="section">
      <h2>Analysis Summary</h2>
      <p><strong>LLM Usage:</strong> 
        {% if llm_meta.enabled %}
          {{ llm_meta.provider }} ({{ llm_meta.model }}) - {{ llm_stats.added }} assertions added
        {% else %}
          Disabled ({{ llm_meta.reason or 'off' }})
        {% endif %}
      </p>
      <p><strong>EoP Testing:</strong> {{ eop_mode }} mode - {{ eop_rows|selectattr('tested')|list|length }}/{{ eop_rows|length }} functions tested</p>
    </div>

  </div>
</body></html>
