{% extends "base.html" %}

{% block title %}Projects ‚Äî UatuAudit{% endblock %}

{% block header_content %}
<!-- Projects title in grid cells 3-6 -->
<div class="grid-cell" style="grid-column:3/7; grid-row:1/2; display:flex; align-items:center; padding-left:20px;">
  <h1 class="page-title" style="color:var(--ice-100); font-size:24px; font-weight:700;">Projects</h1>
</div>
<!-- Menu cells for spacing -->
<div class="grid-cell menu-cell" style="grid-column:7/8; grid-row:1/2;"></div>
<div class="grid-cell menu-cell" style="grid-column:8/9; grid-row:1/2;"></div>
<!-- Add New Project button in grid cells 9-10 -->
<div class="grid-cell" style="grid-column:9/11; grid-row:1/2; display:flex; align-items:center; justify-content:center;">
  <a href="/onboarding/repos" class="action-btn" style="background:var(--halo-gold); color:var(--ink-900); padding:8px 16px; border-radius:6px; text-decoration:none; font-weight:600; transition:all 0.2s;">+ Add New Project</a>
</div>
{% endblock %}

{% block main_content %}
<!-- Fill remaining grid cells to complete 12x8 layout -->
{% for row in range(2, 9) %}
  {% for col in range(1, 13) %}
    <div class="grid-cell" style="grid-column:{{ col }}/{{ col + 1 }}; grid-row:{{ row }}/{{ row + 1 }};"></div>
  {% endfor %}
{% endfor %}

<!-- Processing banner overlay (when audit in progress) -->
<div style="position:absolute; top:12.5%; left:25%; width:50%; height:12.5%; z-index:20; display:none; background:linear-gradient(90deg, rgba(76, 227, 184, 0.1) 0%, rgba(76, 227, 184, 0.05) 100%); border:1px solid var(--mint-400); align-items:center; justify-content:center; gap:16px;" id="processingBanner">
  <div class="spinner" style="width:20px; height:20px; border:2px solid var(--grid-line); border-top-color:var(--mint-400); border-radius:50%; animation:spin 1s linear infinite;"></div>
  <div style="color:var(--ice-100); font-size:14px;">Setting up new audit...</div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
  /* Project-specific styles */
  .project-cell{
    background:rgba(16, 33, 50, 0.4);
    border:1px solid var(--grid-line);
    padding:20px;
    align-items:flex-start;
    justify-content:flex-start;
  }
  
  .project-cell:hover{
    border-color:var(--mint-400);
    background:rgba(76, 227, 184, 0.05);
  }
  
  .project-name{
    font-size:16px;
    font-weight:600;
    color:var(--ice-100);
    margin-bottom:8px;
    width:100%;
  }
  
  .project-id{
    font-family:var(--font-mono);
    font-size:11px;
    color:var(--ice-300);
    opacity:0.6;
    margin-bottom:12px;
  }
  
  .project-stats{
    display:flex;
    gap:12px;
    width:100%;
    margin-top:auto;
  }
  
  .stat-item{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  
  .stat-value{
    font-size:18px;
    font-weight:700;
    color:var(--mint-400);
  }
  
  .stat-label{
    font-size:10px;
    color:var(--ice-300);
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  .spinner{
    width:40px;
    height:40px;
    border:3px solid var(--grid-line);
    border-top-color:var(--mint-400);
    border-radius:50%;
    animation:spin 1s linear infinite;
  }
  
  @keyframes spin{
    to{transform:rotate(360deg);};
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  let projectsData = [];
  
  async function loadProjects(quick = false) {
    try {
      const url = quick ? '/api/projects?quick=true' : '/api/projects';
      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.projects || data.projects.length === 0) {
        // Show empty state in center grid cells
        const centerCell = document.querySelector(`div[style*="grid-column:5/6"][style*="grid-row:4/5"]`);
        if (centerCell) {
          centerCell.style.gridColumn = '5/9';
          centerCell.style.gridRow = '4/6';
          centerCell.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; text-align:center;">
              <div style="font-size:48px; margin-bottom:16px; opacity:0.3;">üì¶</div>
              <div style="font-size:20px; font-weight:600; color:var(--ice-100); margin-bottom:8px;">No projects yet</div>
              <div style="font-size:14px; color:var(--ice-300); margin-bottom:20px;">Start your first audit to see projects here</div>
              <a href="/onboarding/repos" style="background:var(--halo-gold); color:var(--ink-900); padding:8px 16px; border-radius:6px; text-decoration:none; font-weight:600;">Start First Audit</a>
            </div>
          `;
          // Hide covered cells
          for (let r = 4; r < 6; r++) {
            for (let c = 5; c < 9; c++) {
              if (r !== 4 || c !== 5) {
                const cellToHide = document.querySelector(`div[style*="grid-column:${c}/${c+1}"][style*="grid-row:${r}/${r+1}"]`);
                if (cellToHide) cellToHide.style.display = 'none';
              }
            }
          }
        }
        return;
      }
      
      projectsData = data.projects;
      renderProjects();
      
    } catch (error) {
      console.error('Failed to load projects:', error);
      // Show error state in center grid cells
      const centerCell = document.querySelector(`div[style*="grid-column:5/6"][style*="grid-row:4/5"]`);
      if (centerCell) {
        centerCell.style.gridColumn = '5/9';
        centerCell.style.gridRow = '4/6';
        centerCell.innerHTML = `
          <div style="display:flex; flex-direction:column; align-items:center; text-align:center;">
            <div style="font-size:48px; margin-bottom:16px; opacity:0.3;">‚ö†Ô∏è</div>
            <div style="font-size:20px; font-weight:600; color:var(--ice-100); margin-bottom:8px;">Error loading projects</div>
            <div style="font-size:14px; color:var(--ice-300);">Please refresh the page</div>
          </div>
        `;
      }
    }
  }
  
  function renderProjects() {
    // Instead of overlay, find and replace specific grid cells
    // Projects will merge 3x1 grid areas starting from row 3 (3 columns, 1 row)
    let col = 1;
    let row = 3;
    
    projectsData.forEach((project, index) => {
      // Find the first grid cell in this 3x1 area and replace it with project content
      const targetCell = document.querySelector(`div[style*="grid-column:${col}/${col+1}"][style*="grid-row:${row}/${row+1}"]`);
      if (targetCell) {
        // Transform this cell into a project cell that spans 3x1
        targetCell.style.gridColumn = `${col}/${col+3}`;
        targetCell.style.gridRow = `${row}/${row+1}`;
        targetCell.className = 'grid-cell project-cell interactive';
        
        // Hide the other cells that are now covered by this merged cell
        for (let c = col; c < col + 3; c++) {
          if (c !== col) { // Skip the main cell we're using
            const cellToHide = document.querySelector(`div[style*="grid-column:${c}/${c+1}"][style*="grid-row:${row}/${row+1}"]`);
            if (cellToHide) {
              cellToHide.style.display = 'none';
            }
          }
        }
        
        // Count branches, contracts, and reports
        const branchCount = project.branches ? project.branches.length : 0;
        const contractCount = project.branches ? 
          project.branches.reduce((sum, b) => sum + (b.contract_count || 0), 0) : 0;
        const reportCount = project.branches ? 
          project.branches.reduce((sum, b) => sum + (b.reports ? b.reports.length : 0), 0) : 0;
        
        // Get latest branch info
        const latestBranch = project.branches && project.branches.length > 0 ? 
          project.branches[project.branches.length - 1] : null;
        const lastScan = latestBranch ? 
          (latestBranch.created_at ? new Date(latestBranch.created_at).toLocaleDateString() : 'Unknown') : 'Never';
        
        // Check if there are any critical/high findings
        let riskLevel = 'Low';
        let riskColor = 'var(--mint-400)';
        if (project.branches) {
          const hasCritical = project.branches.some(b => b.reports && b.reports.some(r => r.severity === 'Critical'));
          const hasHigh = project.branches.some(b => b.reports && b.reports.some(r => r.severity === 'High'));
          if (hasCritical) {
            riskLevel = 'Critical';
            riskColor = '#E74C3C';
          } else if (hasHigh) {
            riskLevel = 'High';
            riskColor = '#F39C12';
          } else if (reportCount > 0) {
            riskLevel = 'Medium';
            riskColor = '#F7D046';
          }
        }
        
        targetCell.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
            <div class="project-name">${project.owner_repo}</div>
            <div style="font-size:10px; color:${riskColor}; font-weight:600; text-transform:uppercase;">${riskLevel}</div>
          </div>
          <div class="project-id">ID: ${project.id}</div>
          <div style="font-size:11px; color:var(--ice-300); margin-bottom:12px;">Last scan: ${lastScan}</div>
          <div class="project-stats">
            <div class="stat-item">
              <div class="stat-value">${contractCount}</div>
              <div class="stat-label">Contracts</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${branchCount}</div>
              <div class="stat-label">Branches</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${reportCount}</div>
              <div class="stat-label">Reports</div>
            </div>
          </div>
        `;
        
        targetCell.onclick = () => {
          window.location.href = `/project/${encodeURIComponent(project.id)}`;
        };
      }
      
      // Move to next position
      col += 3;
      if (col > 10) {
        col = 1;
        row += 2;
      }
    });
  }
  
  // Check for audit in progress
  async function checkAuditStatus() {
    try {
      const response = await fetch('/api/quick/status');
      const data = await response.json();
      
      const banner = document.getElementById('processingBanner');
      if (data.current_audit && 
          (data.current_audit.status === 'cloning' || 
           data.current_audit.status === 'running' || 
           data.current_audit.status === 'processing')) {
        banner.style.display = 'flex';
      } else {
        banner.style.display = 'none';
      }
    } catch (error) {
      console.error('Status check failed:', error);
    }
  }
  
  // Initial load
  loadProjects(true);
  checkAuditStatus();
  
  // Periodic updates
  setInterval(() => {
    checkAuditStatus();
    loadProjects(true);
  }, 5000);
</script>
{% endblock %}