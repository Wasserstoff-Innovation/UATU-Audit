{% extends "base.html" %}

{% block title %}{{ project.name }} â€” UatuAudit{% endblock %}

{% set show_back_button = true %}
{% set back_url = '/projects' %}

{% block header_content %}
<!-- Project title in grid cells 3-8 -->
<div class="grid-cell" style="grid-column:3/9; grid-row:1/2; display:flex; align-items:center; padding-left:20px;">
  <div>
    <h1 class="project-title" style="color:var(--ice-100); font-size:24px; font-weight:700; margin:0;">{{ project.name }}</h1>
    <div class="project-breadcrumb" style="color:var(--ice-300); font-size:12px; margin-top:4px;">projects / {{ project.path }}</div>
  </div>
</div>
<!-- Menu cells for spacing -->
<div class="grid-cell menu-cell" style="grid-column:9/10; grid-row:1/2;"></div>
<div class="grid-cell menu-cell" style="grid-column:10/11; grid-row:1/2;"></div>
{% endblock %}

{% block main_content %}
<!-- Fill remaining grid cells to complete 12x8 layout -->
{% for row in range(2, 9) %}
  {% for col in range(1, 13) %}
    <div class="grid-cell" style="grid-column:{{ col }}/{{ col + 1 }}; grid-row:{{ row }}/{{ row + 1 }};"></div>
  {% endfor %}
{% endfor %}

<!-- Branches section -->
{% if project.branches %}
  {% for branch in project.branches %}
    {% set branch_count = project.branches|length %}
    {% if branch_count == 1 %}
      <!-- Single branch: use 8 columns centered, 4 rows tall -->
      <div class="grid-cell branch-cell interactive" 
           style="grid-column:3/11; grid-row:3/7;"
           onclick="viewBranch('{{ project.path }}', '{{ branch.name }}')">
    {% elif branch_count == 2 %}
      <!-- Two branches: 6 columns each -->
      <div class="grid-cell branch-cell interactive" 
           style="grid-column:{{ 1 + loop.index0 * 6 }}/{{ 7 + loop.index0 * 6 }}; grid-row:3/6;"
           onclick="viewBranch('{{ project.path }}', '{{ branch.name }}')">
    {% else %}
      <!-- Multiple branches: 4 columns each -->
      <div class="grid-cell branch-cell interactive" 
           style="grid-column:{{ 1 + (loop.index0 % 3) * 4 }}/{{ 5 + (loop.index0 % 3) * 4 }}; 
                  grid-row:{{ 3 + (loop.index0 // 3) * 2 }}/{{ 5 + (loop.index0 // 3) * 2 }};"
           onclick="viewBranch('{{ project.path }}', '{{ branch.name }}')">
    {% endif %}
      <div class="branch-name">{{ branch.name }}</div>
      
      <div class="branch-stats">
        <div class="stat-item">
          <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 100 4h2a2 2 0 100-4 1 1 0 100-2H6a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6a2 2 0 00-2 2v1h4a1 1 0 110 2H4V5z" clip-rule="evenodd"/>
          </svg>
          <span class="stat-value">{{ branch.source_count }} contracts</span>
        </div>
        <div class="stat-item">
          <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
          </svg>
          <span class="stat-value">{{ branch.test_count }} tests</span>
        </div>
      </div>
      
      <div class="branch-actions">
        <button class="action-btn primary" onclick="event.stopPropagation(); runAudit('{{ branch.name }}')">
          ðŸ¤– Run AI Audit
        </button>
        <button class="action-btn" onclick="event.stopPropagation(); viewReport('{{ branch.name }}')">
          ðŸ“Š View Report
        </button>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="grid-cell empty-state" style="grid-column:5/9; grid-row:4/6;">
    <div style="font-size:48px; margin-bottom:16px; opacity:0.3;">ðŸŒ¿</div>
    <div style="font-size:20px; font-weight:600; color:var(--ice-100); margin-bottom:8px;">
      No branches found
    </div>
    <div style="font-size:14px; color:var(--ice-300);">
      This project doesn't have any branches set up yet
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
  /* Project-specific styles */
  .project-title{
    font-size:24px;
    font-weight:700;
    color:var(--ice-100);
    margin-bottom:4px;
  }
  
  .project-breadcrumb{
    font-size:12px;
    color:var(--ice-300);
    font-family:var(--font-mono);
  }
  
  .branch-cell{
    background:rgba(16, 33, 50, 0.8);
    border:2px solid var(--grid-line);
    padding:20px;
    align-items:flex-start;
    justify-content:flex-start;
    position:relative;
    z-index:5;
    box-shadow:0 0 0 1px rgba(16, 33, 50, 0.8);
  }
  
  .branch-cell:hover{
    border-color:var(--mint-400);
    background:rgba(76, 227, 184, 0.05);
    z-index:6;
  }
  
  .branch-name{
    font-size:18px;
    font-weight:600;
    color:var(--ice-100);
    margin-bottom:12px;
    width:100%;
  }
  
  .branch-stats{
    display:flex;
    gap:20px;
    width:100%;
    margin-bottom:16px;
  }
  
  .stat-item{
    display:flex;
    align-items:center;
    gap:8px;
  }
  
  .stat-icon{
    width:16px;
    height:16px;
    opacity:0.7;
  }
  
  .stat-value{
    font-size:14px;
    color:var(--ice-300);
  }
  
  .branch-actions{
    display:flex;
    gap:12px;
    width:100%;
    margin-top:auto;
  }
  
  .action-btn{
    background:transparent;
    border:1px solid var(--grid-line);
    color:var(--ice-300);
    padding:6px 12px;
    border-radius:4px;
    font-size:13px;
    font-weight:500;
    cursor:pointer;
    transition:all 0.2s;
    text-decoration:none;
    display:inline-block;
  }
  
  .action-btn.primary{
    background:var(--halo-gold);
    color:var(--ink-900);
    border:none;
    font-weight:600;
  }
  
  .action-btn.primary:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(247,208,70,0.4);
  }
  
  .action-btn:hover{
    border-color:var(--mint-400);
    color:var(--mint-400);
  }
  
  .empty-state{
    flex-direction:column;
    padding:40px;
    text-align:center;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  function viewBranch(project, branch) {
    window.location.href = `/project/${project}/branch/${branch}`;
  }
  
  async function runAudit(branch) {
    if (confirm(`Start AI audit for ${branch}? This will automatically generate tests and run security analysis.`)) {
      try {
        const response = await fetch('/api/audit/run', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            project: '{{ project.path }}',
            branch: branch
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('AI Audit started! Redirecting to real-time results...');
          window.location.href = `/run/${result.audit_id}`;
        } else {
          alert('Failed to start AI audit');
        }
      } catch (error) {
        alert('Error starting audit: ' + error.message);
      }
    }
  }
  
  function viewReport(branch) {
    // Navigate to the latest audit report for this branch
    window.location.href = `/project/{{ project.path }}/branch/${branch}/reports`;
  }
</script>
{% endblock %}