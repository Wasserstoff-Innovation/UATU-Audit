{% extends "base.html" %}

{% block title %}{{ branch.name }} ‚Äî {{ project.name }} ‚Äî UatuAudit{% endblock %}

{% set show_back_button = true %}
{% set back_url = '/project/' + project.name %}

{% block header_content %}
<!-- Keep header empty to not interfere with back button -->
{% endblock %}

{% block main_content %}
<!-- Test Cases Section - Full width -->
<div class="test-section" style="grid-column:1/13; grid-row:2/9; display:flex; flex-direction:column; margin:0 20px;">
  <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <div style="color:var(--ice-300); font-size:14px;">{{ tests|length }} test files found</div>
    <button class="action-btn primary" onclick="runAllTests()" {% if tests|length == 0 %}disabled style="opacity:0.5; cursor:not-allowed;"{% endif %}>
      üöÄ Run All Tests
    </button>
  </div>
  
  <div class="test-table-container" style="flex:1; overflow-y:auto;">
    <table class="test-table">
      <thead>
        <tr>
          <th>Test Name</th>
          <th>Category</th>
          <th>Journey</th>
          <th>Status</th>
          <th>Last Run</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="testTableBody">
        <!-- Test cases will be populated by JavaScript -->
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
  /* Test Cases Section */
  .test-section{
    background:rgba(16, 33, 50, 0.4);
    border:none;
    padding:20px;
    border-radius:6px;
    height:calc(100% - 40px);
  }
  
  .section-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
  }
  
  .test-table-container{
    flex:1;
    overflow-y:auto;
    height:calc(100% - 60px);
  }
  
  .test-table{
    width:100%;
    border-collapse:collapse;
    background:rgba(16, 33, 50, 0.6);
    border-radius:6px;
    overflow:hidden;
  }
  
  .test-table th,
  .test-table td{
    padding:12px 16px;
    text-align:left;
    border-bottom:1px solid var(--grid-line);
  }
  
  .test-table th{
    background:rgba(16, 33, 50, 0.8);
    color:var(--ice-100);
    font-weight:600;
      font-size:14px;
    position:sticky;
    top:0;
    z-index:10;
  }
  
  .test-table td{
    color:var(--ice-200);
      font-size:13px;
  }
  
  .test-table tr:hover{
    background:rgba(76, 227, 184, 0.05);
  }
  
  .status-badge{
    padding:4px 8px;
    border-radius:4px;
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
    display:inline-block;
  }
  
  .status-pending{
    background:rgba(243, 156, 18, 0.2);
    color:var(--warn);
  }
  
  .status-running{
    background:rgba(52, 152, 219, 0.2);
    color:#3498db;
  }
  
  .status-passed{
    background:rgba(39, 174, 96, 0.2);
    color:var(--success);
  }
  
  .status-failed{
    background:rgba(231, 76, 60, 0.2);
    color:var(--danger);
    }
    
    .test-actions{
      display:flex;
      gap:8px;
    }
    
  .test-btn{
      background:transparent;
      border:1px solid var(--grid-line);
      color:var(--ice-300);
      padding:4px 8px;
    border-radius:3px;
      font-size:11px;
      cursor:pointer;
      transition:all 0.2s;
  }
  
  .test-btn:hover{
    border-color:var(--mint-400);
    color:var(--mint-400);
  }
  
  .test-btn.primary{
    background:var(--halo-gold);
      color:var(--ink-900);
      border:none;
      font-weight:600;
    }
    
  .test-btn.primary:hover{
      transform:translateY(-1px);
    box-shadow:0 2px 8px rgba(247,208,70,0.3);
  }
  
    .empty-state{
    display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    height:200px;
    color:var(--ice-300);
  }
  
  .empty-state-icon{
    font-size:48px;
    margin-bottom:16px;
    opacity:0.3;
  }
  
  .empty-state-text{
    font-size:16px;
      font-weight:600;
    margin-bottom:8px;
  }
  
  .empty-state-subtext{
      font-size:14px;
    opacity:0.7;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Use real test files from backend
  const realTests = {{ tests | tojson if tests else '[]' | safe }};
  console.log('Real tests from backend:', realTests);
  
  // Convert real test files to test cases with proper structure
  const testCases = realTests.map((test, index) => ({
    id: `test_${test.name}`,
    name: test.name,
    category: 'Solidity Test',
    journey: 'Test Suite',
    status: 'pending',
    lastRun: null,
    filePath: test.file_path,
    fullPath: test.full_path,
    description: `Solidity test file: ${test.file_path}`,
    log: null
  }));

  function renderTestTable() {
    const tbody = document.getElementById('testTableBody');
    if (!tbody) return;

    if (testCases.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="empty-state">
            <div class="empty-state-icon">üß™</div>
            <div class="empty-state-text">No test files found</div>
            <div class="empty-state-subtext">Add .sol test files to the test/ or tests/ directory</div>
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = testCases.map(test => `
      <tr>
        <td>
          <div style="font-weight:600; color:var(--ice-100);">${test.name}</div>
          <div style="font-size:11px; color:var(--ice-300); margin-top:2px;">${test.description}</div>
        </td>
        <td>
          <span style="padding:2px 6px; background:rgba(247, 208, 70, 0.1); color:var(--halo-gold); border-radius:3px; font-size:11px; font-weight:600;">
            ${test.category}
          </span>
        </td>
        <td>
          <span style="padding:2px 6px; background:rgba(76, 227, 184, 0.1); color:var(--mint-400); border-radius:3px; font-size:11px; font-weight:600;">
            ${test.journey}
          </span>
        </td>
        <td>
          <span class="status-badge status-${test.status}">
            ${test.status.toUpperCase()}
          </span>
        </td>
        <td style="color:var(--ice-300); font-size:12px;">
          ${test.lastRun || 'Never'}
        </td>
        <td>
          <div class="test-actions">
            <button class="test-btn primary" onclick="runTest('${test.id}')">
              ‚ñ∂ Run
            </button>
            <button class="test-btn" onclick="viewTestDetails('${test.id}')">
              üëÅ View
            </button>
            ${test.log ? `<button class="test-btn" onclick="viewTestLog('${test.id}')">üìã Log</button>` : ''}
          </div>
        </td>
      </tr>
    `).join('');
  }

  async function runTest(testId) {
    const test = testCases.find(t => t.id === testId);
    if (!test) return;

    // Update status to running
    test.status = 'running';
    test.lastRun = new Date().toLocaleString();
    renderTestTable();

    try {
      // Make API call to run the actual test
      const response = await fetch('/api/test/run', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          project: '{{ project.name }}',
          branch: '{{ branch.name }}',
          test: test.name
        })
      });

      const result = await response.json();
      
      if (response.ok) {
        test.status = result.success ? 'passed' : 'failed';
        test.log = result.output || result.error || 'No output available';
      } else {
        test.status = 'failed';
        test.log = `Error: ${result.error || 'Test execution failed'}`;
      }
    } catch (error) {
      test.status = 'failed';
      test.log = `Error: ${error.message}`;
    }

    renderTestTable();
  }

  function runAllTests() {
    if (testCases.length === 0) {
      alert('No test files found. Add .sol test files to the test/ or tests/ directory.');
      return;
    }
    
    if (confirm('Run all test cases? This may take several minutes.')) {
      testCases.forEach(test => {
        if (test.status !== 'running') {
          runTest(test.id);
        }
      });
    }
  }

  function viewTestDetails(testId) {
    const test = testCases.find(t => t.id === testId);
    if (!test) return;

    alert(`Test Details:\n\nName: ${test.name}\nCategory: ${test.category}\nJourney: ${test.journey}\nStatus: ${test.status}\nDescription: ${test.description}`);
  }

  function viewTestLog(testId) {
    const test = testCases.find(t => t.id === testId);
    if (!test || !test.log) return;

    // Create a modal-like popup for the log
    const logWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
    logWindow.document.write(`
      <html>
        <head>
          <title>Test Log - ${test.name}</title>
          <style>
            body { 
              font-family: 'IBM Plex Mono', monospace; 
              background: #0B1B2B; 
              color: #F2F7FB; 
              padding: 20px; 
              margin: 0;
              line-height: 1.6;
            }
            .header { 
              border-bottom: 2px solid #4CE3B8; 
              padding-bottom: 10px; 
              margin-bottom: 20px; 
            }
            .log-content { 
              white-space: pre-wrap; 
              background: rgba(16, 33, 50, 0.6); 
              padding: 15px; 
              border-radius: 6px; 
              border: 1px solid rgba(84, 130, 158, 0.4);
            }
            .test-info {
              background: rgba(76, 227, 184, 0.1);
              padding: 10px;
              border-radius: 4px;
              margin-bottom: 15px;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Test Log: ${test.name}</h1>
            <div class="test-info">
              <strong>Category:</strong> ${test.category} | 
              <strong>Journey:</strong> ${test.journey} | 
              <strong>Status:</strong> ${test.status.toUpperCase()} | 
              <strong>Last Run:</strong> ${test.lastRun || 'Never'}
            </div>
          </div>
          <div class="log-content">${test.log}</div>
        </body>
      </html>
    `);
    logWindow.document.close();
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    renderTestTable();
    });
  </script>
{% endblock %}