{% extends "base.html" %}

{% block title %}Select Repository ‚Äî UatuAudit{% endblock %}

{% set show_back_button = true %}
{% set back_url = '/dashboard' %}

{% block header_content %}
<!-- Repository selection title in grid cells 3-7 -->
<div class="grid-cell" style="grid-column:3/8; grid-row:1/2; display:flex; align-items:center; padding-left:20px;">
  <h1 class="page-title" style="color:var(--ice-100); font-size:24px; font-weight:700;">Select Repository</h1>
</div>
<!-- Menu cells for spacing -->
<div class="grid-cell menu-cell" style="grid-column:8/9; grid-row:1/2;"></div>
<div class="grid-cell menu-cell" style="grid-column:9/10; grid-row:1/2;"></div>
<div class="grid-cell menu-cell" style="grid-column:10/11; grid-row:1/2;"></div>
{% endblock %}

{% block main_content %}
<!-- Repository selection content -->
<div style="grid-column:1/13; grid-row:2/9; padding:20px;">
  <div class="onboarding-container">
    <div class="step-indicator">
      <div class="step active">1. Connect GitHub</div>
      <div class="step active">2. Select Repository</div>
      <div class="step">3. Configure Audit</div>
    </div>
    
    <div class="repo-selection">
      <h2 style="color:var(--ice-100); margin-bottom:16px;">Choose a Repository</h2>
      <p class="muted" style="margin-bottom:24px;">Select the repository you want to audit.</p>
      
      <div id="repos-container">
        <div class="loading" style="text-align:center; padding:40px; color:var(--ice-300);">
          Loading repositories...
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
  .onboarding-container {
    max-width: 800px;
    margin: 0 auto;
  }
  
  .step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 40px;
    gap: 20px;
  }
  
  .step {
    padding: 8px 16px;
    border-radius: 20px;
    background: rgba(16, 33, 50, 0.3);
    color: var(--ice-300);
    border: 1px solid var(--grid-line);
    font-size: 14px;
    font-weight: 500;
  }
  
  .step.active {
    background: var(--halo-gold);
    color: var(--ink-900);
    border-color: var(--halo-gold);
  }
  
  .repo-item {
    background: rgba(16, 33, 50, 0.4);
    border: 1px solid var(--grid-line);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .repo-item:hover {
    border-color: var(--mint-400);
    background: rgba(76, 227, 184, 0.05);
  }
  
  .repo-item.selected {
    border-color: var(--halo-gold);
    background: rgba(247, 208, 70, 0.1);
  }
  
  .repo-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--ice-100);
    margin-bottom: 8px;
  }
  
  .repo-description {
    color: var(--ice-300);
    font-size: 14px;
    margin-bottom: 12px;
  }
  
  .repo-meta {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--ice-300);
  }
  
  .muted {
    color: var(--ice-300);
  }
  
  .btn {
    display: inline-block;
    padding: 12px 24px;
    background: var(--halo-gold);
    color: var(--ink-900);
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  
  .btn:hover {
    background: var(--mint-400);
    transform: translateY(-1px);
  }
  
  .btn:disabled {
    background: var(--ice-300);
    cursor: not-allowed;
    transform: none;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  let selectedRepo = null;
  
  document.addEventListener('DOMContentLoaded', function() {
    loadRepositories();
  });

  async function loadRepositories() {
    try {
      const response = await fetch('/api/github/repos');
      if (response.ok) {
        const data = await response.json();
        displayRepositories(data.repos || []);
      } else {
        console.error('Failed to load repositories');
        document.getElementById('repos-container').innerHTML = 
          '<div style="text-align:center; color:var(--ice-300); padding:40px;">Failed to load repositories. Please try again.</div>';
      }
    } catch (error) {
      console.error('Error loading repositories:', error);
      document.getElementById('repos-container').innerHTML = 
        '<div style="text-align:center; color:var(--ice-300); padding:40px;">Error loading repositories. Please try again.</div>';
    }
  }

  function displayRepositories(repos) {
    const container = document.getElementById('repos-container');
    
    if (repos.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; color:var(--ice-300); padding:40px;">
          <h3>No repositories found</h3>
          <p>Make sure you have repositories in your GitHub account.</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = repos.map(repo => `
      <div class="repo-item" onclick="selectRepo('${repo.name}', '${repo.full_name}')">
        <div class="repo-name">${repo.name}</div>
        <div class="repo-description">${repo.description || 'No description available'}</div>
        <div class="repo-meta">
          <span>‚≠ê ${repo.stargazers_count || 0} stars</span>
          <span>üç¥ ${repo.forks_count || 0} forks</span>
          <span>üìÖ Updated ${new Date(repo.updated_at).toLocaleDateString()}</span>
        </div>
      </div>
    `).join('') + `
      <div style="text-align:center; margin-top:32px;">
        <button class="btn" id="continue-btn" onclick="continueToNext()" disabled>
          Continue to Configuration
        </button>
      </div>
    `;
  }

  function selectRepo(name, fullName) {
    // Remove previous selection
    document.querySelectorAll('.repo-item').forEach(item => {
      item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    event.currentTarget.classList.add('selected');
    
    selectedRepo = { name, fullName };
    document.getElementById('continue-btn').disabled = false;
  }

  function continueToNext() {
    if (selectedRepo) {
      // Store selected repo and redirect to configuration
      localStorage.setItem('selectedRepo', JSON.stringify(selectedRepo));
      window.location.href = '/setup-project';
    }
  }
</script>
{% endblock %}
